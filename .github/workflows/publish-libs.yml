name: Publish libs

#on:
#  release:
#    types: [published]
on:
  push:
    branches:
      - '**'
jobs:
  publish:
    name: Publish packages
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package:
          [
            { name: 'lib-apiclient' },
            { name: 'lib-auth' },
            { name: 'lib-aws' },
            { name: 'lib-components' },
            { name: 'lib-config' },
            { name: 'lib-db' },
            { name: 'lib-email' },
            { name: 'lib-function-helpers' },
            { name: 'lib-gameserver' },
            { name: 'lib-http' },
            { name: 'lib-modules' },
            { name: 'lib-queues' },
            { name: 'lib-util' },
          ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.18
          cache: 'npm'
          scope: '@takaro'

      - run: ./scripts/dev-init.sh

      - run: npm -w packages/${{ matrix.package.name }} publish --provenance --access public --verbose
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
