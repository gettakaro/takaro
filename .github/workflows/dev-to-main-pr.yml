# Takaro merges feature branches into the development branch first
# and then merges the development branch into the main branch.

# This workflow automates the process of creating a pull request from the development branch to the main branch.

name: Create dev to main PR
on:
  push:
    branches:
      - development
      - main
jobs:
  mainPromotion:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/development'
    steps:
      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.TAKARO_CI_APP_ID }}
          private_key: ${{ secrets.TAKARO_CI_APP_PRIV_KEY }}
      - uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ steps.generate_token.outputs.token }}
      - name: Reset promotion branch
        run: |
          git fetch origin development:development
          git fetch origin main:refs/remotes/origin/main
          git reset --hard development
      - name: Generate PR list
        id: pr_list
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          set -e  # Exit on any error
          
          echo "Fetching PR list..."
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Main branch: $(git rev-parse origin/main)"
          
          # Ensure we have the required tools
          if ! command -v gh &> /dev/null; then
            echo "Error: gh CLI not found"
            exit 1
          fi
          
          if ! command -v jq &> /dev/null; then
            echo "Error: jq not found"
            exit 1
          fi
          
          # Get merge commits between main and development using explicit branch comparison
          echo "Getting merge commits..."
          git fetch origin development:refs/remotes/origin/development
          
          # Use explicit branch comparison to avoid stale references
          PR_LIST=$(git log origin/main..origin/development --merges --pretty=format:"%H %s" | grep -E "Merge pull request #[0-9]+" | head -20 || true)
          
          echo "Found merge commits: $PR_LIST"
          
          # Format PR list as markdown
          PR_MARKDOWN=""
          PR_COUNT=0
          
          if [ -n "$PR_LIST" ]; then
            echo "Processing PR list..."
            while IFS= read -r line; do
              if [ -n "$line" ]; then
                echo "Processing line: $line"
                PR_NUM=$(echo "$line" | grep -oE "#[0-9]+" | tr -d '#' || true)
                echo "Extracted PR number: $PR_NUM"
                
                if [ -n "$PR_NUM" ] && [ "$PR_NUM" != "" ]; then
                  echo "Fetching details for PR #$PR_NUM"
                  # Get PR details using gh CLI with better error handling
                  if PR_INFO=$(gh pr view "$PR_NUM" --json number,title,author,url,baseRefName 2>/dev/null); then
                    if [ -n "$PR_INFO" ] && [ "$PR_INFO" != "null" ]; then
                      PR_TITLE=$(echo "$PR_INFO" | jq -r '.title // "Unknown"' || echo "Unknown")
                      PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.author.login // "unknown"' || echo "unknown")
                      PR_BASE=$(echo "$PR_INFO" | jq -r '.baseRefName // "unknown"' || echo "unknown")
                      
                      # Filter out automated merge PRs and bot PRs
                      SKIP_PR=false
                      
                      # Skip if it's a "Merge development into main" PR
                      if [[ "$PR_TITLE" =~ ^ðŸ¤–.*Merge\ development\ into\ main ]] || [[ "$PR_TITLE" =~ Merge\ development\ into\ main ]]; then
                        echo "Skipping automated merge PR #$PR_NUM: $PR_TITLE"
                        SKIP_PR=true
                      fi
                      
                      # Skip if it's created by CI bot and targets main
                      if [[ "$PR_AUTHOR" == "takaro-ci-bot[bot]" ]] && [[ "$PR_BASE" == "main" ]]; then
                        echo "Skipping bot PR to main #$PR_NUM: $PR_TITLE"
                        SKIP_PR=true
                      fi
                      
                      # Skip PRs with skip-changelog label (they are merge PRs)
                      if [[ "$PR_TITLE" =~ ðŸ¤– ]] && [[ "$PR_BASE" == "main" ]]; then
                        echo "Skipping automated PR #$PR_NUM: $PR_TITLE"
                        SKIP_PR=true
                      fi
                      
                      if [ "$SKIP_PR" = false ]; then
                        PR_MARKDOWN="${PR_MARKDOWN}- #${PR_NUM}: ${PR_TITLE} (@${PR_AUTHOR})\n"
                        PR_COUNT=$((PR_COUNT + 1))
                        echo "Added PR #$PR_NUM to list (count: $PR_COUNT)"
                      fi
                    else
                      echo "Warning: Empty PR info for #$PR_NUM"
                    fi
                  else
                    echo "Warning: Could not fetch details for PR #$PR_NUM"
                  fi
                fi
              fi
            done <<< "$PR_LIST"
          else
            echo "No merge commits found between origin/main and origin/development"
          fi
          
          echo "Final PR count: $PR_COUNT"
          
          # Create the PR body
          if [ "$PR_COUNT" -eq 0 ]; then
            PR_BODY="This PR merges the development branch into the main branch.\n\nNo pull requests found between branches."
          else
            PR_BODY="This PR merges the development branch into the main branch.\n\n## Included Pull Requests (${PR_COUNT})\n\n${PR_MARKDOWN}"
          fi
          
          # Add comparison link
          if REPO_URL=$(gh repo view --json url -q .url 2>/dev/null); then
            PR_BODY="${PR_BODY}\n\n## Branch Comparison\n[View all changes](${REPO_URL}/compare/main...development)"
          else
            echo "Warning: Could not fetch repository URL"
          fi
          
          # Save to file to handle multiline content
          echo -e "$PR_BODY" > "$GITHUB_WORKSPACE/pr_body.txt"
          echo "PR body saved to file"
          
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: main-promotion
          labels: skip-changelog
          token: ${{ steps.generate_token.outputs.token }}
          title: ðŸ¤– Merge development into main
          body-path: ${{ github.workspace }}/pr_body.txt

  updateDevelopment:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.TAKARO_CI_APP_ID }}
          private_key: ${{ secrets.TAKARO_CI_APP_PRIV_KEY }}
      - uses: actions/checkout@v4
        with:
          ref: development
          token: ${{ steps.generate_token.outputs.token }}
      - name: Update dev
        run: |
          git config --global user.name 'takaro-ci-bot[bot]'
          git config --global user.email '138661031+takaro-ci-bot[bot]@users.noreply.github.com'        
          git fetch origin main:main
          git rebase main
          git push --force-with-lease origin development
